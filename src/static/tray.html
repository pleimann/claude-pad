<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Camel Pad</title>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-size: 13px;
        background: #f5f5f7;
        color: #1d1d1f;
        padding: 20px 24px 24px;
        min-width: 480px;
        max-width: 600px;
        margin: 0 auto;
      }

      /* ── Tab bar ── */
      .tab-bar {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
      }

      .tab-seg {
        display: flex;
        background: #e0e0e5;
        border-radius: 8px;
        padding: 2px;
        gap: 2px;
      }

      .tab-btn {
        padding: 5px 20px;
        border: none;
        border-radius: 6px;
        background: transparent;
        font-size: 13px;
        font-family: inherit;
        font-weight: 500;
        color: #6e6e73;
        cursor: pointer;
        transition:
          background 0.15s,
          color 0.15s;
        white-space: nowrap;
      }

      .tab-btn.active {
        background: #fff;
        color: #1d1d1f;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
      }

      /* ── Views ── */
      .view {
        display: none;
      }
      .view.active {
        display: block;
      }

      /* ── Shared card ── */
      .section,
      .ctrl-section {
        background: #fff;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .section h2,
      .ctrl-section h2 {
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #6e6e73;
        margin-bottom: 12px;
      }

      /* ── Settings: fields ── */
      .field {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 6px 0;
      }

      .field:not(:last-child) {
        /* border-bottom: 1px solid #f0f0f2; */
      }

      .field label {
        flex: 0 0 160px;
        color: #1d1d1f;
      }

      .field input[type="text"],
      .field input[type="number"],
      .field select {
        flex: 1;
        height: 28px;
        border: 1px solid #d2d2d7;
        border-radius: 6px;
        padding: 0 8px;
        font-size: 13px;
        font-family: inherit;
        background: #fff;
        color: #1d1d1f;
        outline: none;
        transition: border-color 0.15s;
      }

      .field input:focus,
      .field select:focus {
        border-color: #0071e3;
        box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.2);
      }

      .field .hint {
        color: #6e6e73;
        font-size: 11px;
        flex: 0 0 auto;
      }

      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex: 1;
      }

      /* ── Buttons ── */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 28px;
        padding: 0 14px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 13px;
        font-family: inherit;
        font-weight: 500;
        transition: opacity 0.15s;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .btn:hover {
        opacity: 0.85;
      }
      .btn:active {
        opacity: 0.7;
      }

      .btn-primary {
        background: #0071e3;
        color: #fff;
      }
      .btn-secondary {
        background: #e8e8ed;
        color: #1d1d1f;
      }
      .btn-small {
        height: 24px;
        padding: 0 10px;
        font-size: 12px;
      }

      /* ── Settings: footer ── */
      .footer {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 8px;
      }

      /* ── Settings: device mode ── */
      .device-mode {
        display: flex;
        gap: 16px;
        margin-bottom: 12px;
      }

      .device-mode label {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
      }

      #port-section,
      #id-section {
        display: none;
      }
      #port-section.active,
      #id-section.active {
        display: block;
      }

      #scan-results {
        margin-top: 8px;
        display: none;
      }

      #scan-results select {
        width: 100%;
        height: 28px;
        border: 1px solid #d2d2d7;
        border-radius: 6px;
        padding: 0 8px;
        font-size: 13px;
        font-family: inherit;
        background: #fff;
      }

      .status-msg {
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 13px;
        margin-top: 12px;
        display: none;
      }

      .status-msg.success {
        background: #d4f4dd;
        color: #1a5c2a;
        display: block;
      }
      .status-msg.error {
        background: #fde8e8;
        color: #8b1a1a;
        display: block;
      }

      /* ── Control: connection banner ── */
      .conn-banner {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #fff;
        border-radius: 10px;
        padding: 10px 14px;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        font-size: 13px;
        color: #6e6e73;
      }

      .conn-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #c7c7cc;
        flex-shrink: 0;
      }
      .conn-dot.connected {
        background: #30d158;
      }
      .conn-dot.disconnected {
        background: #c7c7cc;
      }

      /* ── Control: generic field row ──
         A horizontal flex row with gap; dividers between rows.
         No fixed label column — labels are inline where needed.       */
      .ctrl-field {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 7px 0;
      }

      .ctrl-field:not(:last-child) {
        /* border-bottom: 1px solid #f0f0f2; */
      }

      /* Text inputs inside ctrl-field grow to fill space */
      .ctrl-field input[type="text"] {
        flex: 1;
        min-width: 0;
        height: 28px;
        border: 1px solid #d2d2d7;
        border-radius: 6px;
        padding: 0 8px;
        font-size: 13px;
        font-family: inherit;
        background: #fff;
        color: #1d1d1f;
        outline: none;
      }

      .ctrl-field input[type="text"]:focus {
        border-color: #0071e3;
        box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.2);
      }

      .ctrl-field .field-controls {
        padding: 4px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
      }

      .ctrl-field textarea {
        flex: 1;
        min-width: 0;
        height: 100px;
        border: 1px solid #d2d2d7;
        border-radius: 6px;
        padding: 6px 8px;
        font-size: 13px;
        font-family: inherit;
        background: #fff;
        color: #1d1d1f;
        outline: none;
        resize: vertical;
      }

      .ctrl-field textarea:focus {
        border-color: #0071e3;
        box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.2);
      }

      /* Short descriptive label within a row ("Status", "Category") */
      .ctrl-dim {
        font-size: 12px;
        color: #6e6e73;
        white-space: nowrap;
        flex-shrink: 0;
      }

      /* Inline ok/error feedback that appears after an action */
      .ctrl-fb {
        font-size: 11px;
        min-width: 0;
        white-space: nowrap;
        color: transparent; /* invisible when empty */
        flex-shrink: 0;
      }
      .ctrl-fb.ok {
        color: #1a5c2a;
      }
      .ctrl-fb.err {
        color: #8b1a1a;
      }

      /* ── Control: sub-section heading ──
         Used within a card to label a group of controls (e.g. "Labels").  */
      .ctrl-sub-h {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #6e6e73;
        padding: 10px 0 4px;
      }

      .ctrl-sub-h:first-child {
        padding-top: 0;
      }

      .ctrl-sub-sep {
        border: none;
        border-top: 1px solid #f0f0f2;
        margin: 4px 0 0;
      }

      /* ── Control: 4-up label inputs ── */
      .label-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
        flex: 1;
        min-width: 0;
      }

      .label-grid input[type="text"] {
        width: 100%;
        height: 28px;
        border: 1px solid #d2d2d7;
        border-radius: 6px;
        padding: 0 6px;
        font-size: 12px;
        font-family: inherit;
        background: #fff;
        color: #1d1d1f;
        outline: none;
        min-width: 0;
      }

      .label-grid input[type="text"]:focus {
        border-color: #0071e3;
        box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.2);
      }

      /* ── Control: 4-up LED pickers ── */
      .led-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
        flex: 1;
        min-width: 0;
      }

      .led-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 3px;
        font-size: 11px;
        color: #6e6e73;
      }

      .led-item input[type="color"] {
        width: 100%;
        height: 28px;
        border: 1px solid #d2d2d7;
        border-radius: 6px;
        padding: 2px;
        cursor: pointer;
        background: #fff;
      }

      /* ── Control: notification result ── */
      .notify-result {
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 6px;
        background: #f5f5f7;
        color: #6e6e73;
        margin-top: 8px;
        display: none;
      }
      .notify-result.visible {
        display: block;
      }
      .notify-result.ok {
        background: #d4f4dd;
        color: #1a5c2a;
      }
      .notify-result.err {
        background: #fde8e8;
        color: #8b1a1a;
      }

      /* ── Monitor view ── */
      .mon-toolbar {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
      }

      .mon-toolbar input[type="text"] {
        flex: 1;
        height: 28px;
        border: 1px solid #d2d2d7;
        border-radius: 6px;
        padding: 0 8px;
        font-size: 13px;
        font-family: inherit;
        background: #fff;
        color: #1d1d1f;
        outline: none;
      }

      .mon-toolbar input[type="text"]:focus {
        border-color: #0071e3;
        box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.2);
      }

      .mon-toolbar label {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 13px;
        color: #6e6e73;
        white-space: nowrap;
        cursor: pointer;
      }

      .mon-log {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        height: 340px;
        overflow-y: auto;
        font-family: ui-monospace, "SF Mono", Menlo, monospace;
        font-size: 11.5px;
      }

      .mon-log:empty::after {
        content: "No events yet…";
        display: block;
        padding: 16px;
        color: #c7c7cc;
        text-align: center;
      }

      .log-row {
        display: flex;
        align-items: baseline;
        gap: 8px;
        padding: 5px 12px;
        border-bottom: 1px solid #f5f5f7;
        line-height: 1.4;
      }

      .log-row:last-child {
        border-bottom: none;
      }

      .log-row.filtered {
        display: none;
      }

      .log-ts {
        color: #aeaeb2;
        flex-shrink: 0;
        font-size: 11px;
      }

      .log-dir {
        flex-shrink: 0;
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 0.04em;
        padding: 1px 5px;
        border-radius: 4px;
        width: 32px;
        text-align: center;
      }

      .log-dir-in  { background: #d4f4dd; color: #1a5c2a; }
      .log-dir-out { background: #dde9ff; color: #1a3a8a; }
      .log-dir-sys { background: #f0f0f2; color: #6e6e73; }

      .log-type {
        color: #6e6e73;
        flex-shrink: 0;
        min-width: 90px;
      }

      .log-summary {
        color: #1d1d1f;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
      }

      /* ── Keys view ── */
      .kb-hint {
        font-size: 11px;
        color: #6e6e73;
        margin-bottom: 14px;
        line-height: 1.5;
      }

      .kb-col-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 0 0 4px;
        border-bottom: 1px solid #f0f0f2;
        margin-bottom: 4px;
      }

      .kb-gesture-label {
        flex: 0 0 96px;
        font-size: 13px;
        color: #1d1d1f;
      }

      .kb-col-name {
        flex: 1;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #6e6e73;
      }

      .kb-gesture-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 5px 0;
      }

      .kb-gesture-row input[type="text"] {
        flex: 1;
        min-width: 0;
        height: 28px;
        border: 1px solid #d2d2d7;
        border-radius: 6px;
        padding: 0 8px;
        font-size: 13px;
        font-family: inherit;
        background: #fff;
        color: #1d1d1f;
        outline: none;
      }

      .kb-gesture-row input[type="text"]:focus {
        border-color: #0071e3;
        box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.2);
      }
    </style>
  </head>
  <body>
    <!-- Tab bar -->
    <div class="tab-bar">
      <div class="tab-seg">
        <button class="tab-btn active" data-tab="control" onclick="switchTab('control')">
          Control
        </button>
        <button class="tab-btn" data-tab="settings" onclick="switchTab('settings')">
          Settings
        </button>
        <button class="tab-btn" data-tab="keys" onclick="switchTab('keys')">
          Keys
        </button>
        <button class="tab-btn" data-tab="monitor" onclick="switchTab('monitor')">
          Monitor
        </button>
      </div>
    </div>

    <!-- Connection status -->
    <div class="conn-banner">
      <span class="conn-dot disconnected" id="conn-dot"></span>
      <span id="conn-label">Checking…</span>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         CONTROL VIEW
         Layout math at 480px min-width:
           body padding: 24px × 2 → inner = 432px
           section padding: 16px × 2 → content = 400px
         ═══════════════════════════════════════════════════════════════ -->
    <div id="view-control" class="view active">
      <!-- Display controls
           Row 1: [textarea flex] [Send ~52px]
           Row 2: [Status ~44px] [input flex] [Send ~52px] [fb auto]
           Row 3: [Clear Display ~100px] [fb auto]          -->
      <div class="ctrl-section">
        <h2>Display</h2>

        <div class="ctrl-field">
          <input
            type="text"
            id="ctrl-status"
            style="color: green"
            placeholder="Status bar text…"
          />
          <div class="field-controls">
            <button
              type="button"
              class="btn btn-secondary btn-small"
              onclick="sendStatusText()"
            >
              Send
            </button>
            <span class="ctrl-fb" id="fb-status"></span>
          </div>
        </div>

        <div class="ctrl-field">
          <textarea
            id="ctrl-text"
            placeholder="Text to show on display…"
          ></textarea>
          <div class="field-controls">
            <button
              type="button"
              class="btn btn-secondary btn-small"
              onclick="sendDisplayText()"
            >
              Send
            </button>
            <span class="ctrl-fb" id="fb-text"></span>
          </div>
        </div>

        <div class="ctrl-field">
          <button
            type="button"
            class="btn btn-secondary btn-small"
            onclick="clearDisplay()"
          >
            Clear Display
          </button>
          <span class="ctrl-fb" id="fb-clear"></span>
        </div>
      </div>

      <!-- Button controls
           Labels row: [label-grid flex (4-col grid)] [Apply ~52px] [fb auto]
             label-grid = 400 - 52 - 8gap - 8gap - fb ≈ each col ~80px ✓
           LED row: [led-grid flex (4-col grid)] [fb auto]           -->
      <div class="ctrl-section">
        <h2>Buttons</h2>

        <p class="ctrl-sub-h">Labels</p>
        <div class="ctrl-field">
          <div class="label-grid">
            <input type="text" id="lbl0" placeholder="Key 1" maxlength="12" />
            <input type="text" id="lbl1" placeholder="Key 2" maxlength="12" />
            <input type="text" id="lbl2" placeholder="Key 3" maxlength="12" />
            <input type="text" id="lbl3" placeholder="Key 4" maxlength="12" />
          </div>
          <button
            type="button"
            class="btn btn-secondary btn-small"
            onclick="sendLabels()"
          >
            Apply
          </button>
          <span class="ctrl-fb" id="fb-labels"></span>
        </div>

        <p class="ctrl-sub-h">LED Colors</p>
        <div class="ctrl-field">
          <div class="led-grid">
            <div class="led-item">
              <input
                type="color"
                id="led0"
                value="#000000"
                oninput="sendLeds()"
              /><span>Key 1</span>
            </div>
            <div class="led-item">
              <input
                type="color"
                id="led1"
                value="#000000"
                oninput="sendLeds()"
              /><span>Key 2</span>
            </div>
            <div class="led-item">
              <input
                type="color"
                id="led2"
                value="#000000"
                oninput="sendLeds()"
              /><span>Key 3</span>
            </div>
            <div class="led-item">
              <input
                type="color"
                id="led3"
                value="#000000"
                oninput="sendLeds()"
              /><span>Key 4</span>
            </div>
          </div>
          <span class="ctrl-fb" id="fb-leds"></span>
        </div>
      </div>

      <!-- Notification tester
           Row 1: [text input flex] [Send ~52px]   → trivially fits
           Row 2: [Category ~58px] [category input flex]
           Result box: full width, shown on response              -->
      <!-- <div class="ctrl-section">
        <h2>Notifications</h2>

        <div class="ctrl-field">
          <input
            type="text"
            id="notify-text"
            placeholder="Notification text…"
          />
          <button
            type="button"
            class="btn btn-secondary btn-small"
            onclick="sendNotify()"
          >
            Send
          </button>
        </div>

        <div class="ctrl-field">
          <input
            type="text"
            id="notify-category"
            placeholder="Category (optional)..."
          />
        </div>

        <div class="notify-result" id="notify-result"></div>
      </div> -->
    </div>
    <!-- /view-control -->

    <!-- ═══════════════════════════════════════════════════════════════
         SETTINGS VIEW
         ═══════════════════════════════════════════════════════════════ -->
    <div id="view-settings" class="view">
      <div class="section">
        <h2>Device</h2>

        <div class="device-mode">
          <label
            ><input type="radio" name="deviceMode" value="port" checked />
            Serial Port</label
          >
          <label
            ><input type="radio" name="deviceMode" value="ids" /> Vendor/Product
            ID</label
          >
        </div>

        <div id="port-section" class="active">
          <div class="field">
            <label>Serial Port</label>
            <div class="row">
              <input type="text" id="port" placeholder="/dev/cu.usbmodem..." />
              <button
                type="button"
                class="btn btn-secondary btn-small"
                id="scan-btn"
                onclick="scanDevices()"
              >
                Scan
              </button>
            </div>
          </div>
          <div id="scan-results">
            <select
              id="port-select"
              onchange="document.getElementById('port').value = this.value"
            >
              <option value="">Select a device...</option>
            </select>
          </div>
        </div>

        <div id="id-section">
          <div class="field">
            <label>Vendor ID</label>
            <input type="text" id="vendorId" placeholder="0x303A" />
            <span class="hint">hex</span>
          </div>
          <div class="field">
            <label>Product ID</label>
            <input type="text" id="productId" placeholder="0x1001" />
            <span class="hint">hex</span>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>Orientation</h2>
        <div class="device-mode">
          <label
            ><input type="radio" name="handedness" value="right" checked />
            Right-handed</label
          >
          <label
            ><input type="radio" name="handedness" value="left" />
            Left-handed</label
          >
        </div>
      </div>

      <div class="section">
        <h2>Gestures</h2>
        <div class="field">
          <label>Long Press</label>
          <input
            type="number"
            id="longPressMs"
            min="100"
            max="5000"
            step="50"
          />
          <span class="hint">ms</span>
        </div>
        <div class="field">
          <label>Double Press Window</label>
          <input
            type="number"
            id="doublePressMs"
            min="50"
            max="2000"
            step="50"
          />
          <span class="hint">ms</span>
        </div>
      </div>

      <div class="section">
        <h2>Server</h2>
        <div class="field">
          <label>WebSocket Port</label>
          <input type="number" id="serverPort" min="1024" max="65535" />
        </div>
        <div class="field">
          <label>Host</label>
          <input type="text" id="serverHost" placeholder="localhost" />
        </div>
      </div>

      <div class="section">
        <h2>Notification Timeout</h2>
        <div class="field">
          <label>Timeout</label>
          <input
            type="number"
            id="timeoutMs"
            min="1000"
            max="300000"
            step="1000"
          />
          <span class="hint">ms</span>
        </div>
      </div>

      <div id="status-msg" class="status-msg"></div>

      <div class="footer">
        <button
          type="button"
          class="btn btn-secondary"
          onclick="window.close()"
        >
          Cancel
        </button>
        <button type="button" class="btn btn-primary" onclick="saveConfig()">
          Save
        </button>
      </div>
    </div>
    <!-- /view-settings -->

    <!-- ═══════════════════════════════════════════════════════════════
         KEYS VIEW
         ═══════════════════════════════════════════════════════════════ -->
    <div id="view-keys" class="view">
      <!-- Key cards are generated by renderKeybindings() -->
    </div>
    <!-- /view-keys -->

    <!-- ═══════════════════════════════════════════════════════════════
         MONITOR VIEW
         ═══════════════════════════════════════════════════════════════ -->
    <div id="view-monitor" class="view">
      <div class="mon-toolbar">
        <input type="text" id="mon-filter" placeholder="Filter…" oninput="applyMonitorFilter()" />
        <label><input type="checkbox" id="mon-pause" /> Pause</label>
        <button type="button" class="btn btn-secondary btn-small" onclick="clearMonitorLog()">Clear</button>
      </div>
      <div class="mon-log" id="mon-log"></div>
    </div>
    <!-- /view-monitor -->

    <script>
      let currentConfig = null;
      let statusPollInterval = null;

      // ── Tab switching ────────────────────────────────────────────────

      function switchTab(tab) {
        document.querySelectorAll(".tab-btn").forEach((b) => {
          b.classList.toggle("active", b.dataset.tab === tab);
        });
        document.getElementById("view-control").classList.toggle("active", tab === "control");
        document.getElementById("view-settings").classList.toggle("active", tab === "settings");
        document.getElementById("view-keys").classList.toggle("active", tab === "keys");
        document.getElementById("view-monitor").classList.toggle("active", tab === "monitor");
        if (tab === "monitor") startMonitorPolling();
        else stopMonitorPolling();
      }

      // ── Monitor view ─────────────────────────────────────────────────

      let monitorPollInterval = null;
      let monitorCursor = 0;

      function fmtTime(ts) {
        const d = new Date(ts);
        return d.toLocaleTimeString("en-US", { hour12: false }) + "." +
          String(d.getMilliseconds()).padStart(3, "0");
      }

      function appendLogEntries(entries) {
        if (!entries.length) return;
        const log = document.getElementById("mon-log");
        const filter = document.getElementById("mon-filter").value.toLowerCase();
        const paused = document.getElementById("mon-pause").checked;
        const atBottom = log.scrollHeight - log.scrollTop <= log.clientHeight + 4;

        for (const e of entries) {
          const row = document.createElement("div");
          row.className = "log-row";
          row.dataset.text = `${e.type} ${e.summary}`.toLowerCase();

          const ts = document.createElement("span");
          ts.className = "log-ts";
          ts.textContent = fmtTime(e.ts);

          const dir = document.createElement("span");
          dir.className = `log-dir log-dir-${e.dir}`;
          dir.textContent = e.dir.toUpperCase();

          const type = document.createElement("span");
          type.className = "log-type";
          type.textContent = e.type;

          const summary = document.createElement("span");
          summary.className = "log-summary";
          summary.textContent = e.summary;

          row.append(ts, dir, type, summary);

          if (filter && !row.dataset.text.includes(filter)) {
            row.classList.add("filtered");
          }

          log.appendChild(row);
        }

        // Cap at 1000 visible rows
        while (log.children.length > 1000) log.removeChild(log.firstChild);

        if (!paused && atBottom) log.scrollTop = log.scrollHeight;
      }

      async function pollMonitorLogs() {
        try {
          const res = await fetch(`/api/logs?since=${monitorCursor}`);
          const { entries, cursor } = await res.json();
          monitorCursor = cursor;
          appendLogEntries(entries);
        } catch { /* ignore */ }
      }

      function startMonitorPolling() {
        if (monitorPollInterval) return;
        pollMonitorLogs();
        monitorPollInterval = setInterval(pollMonitorLogs, 1000);
      }

      function stopMonitorPolling() {
        if (monitorPollInterval) { clearInterval(monitorPollInterval); monitorPollInterval = null; }
      }

      function clearMonitorLog() {
        document.getElementById("mon-log").innerHTML = "";
      }

      function applyMonitorFilter() {
        const filter = document.getElementById("mon-filter").value.toLowerCase();
        document.querySelectorAll("#mon-log .log-row").forEach((row) => {
          row.classList.toggle("filtered", !!filter && !row.dataset.text.includes(filter));
        });
      }

      // ── Keys view ────────────────────────────────────────────────────

      const KB_KEY_NAMES = ['Key 1', 'Key 2', 'Key 3', 'Key 4'];
      const KB_GESTURES = [
        { id: 'press',       snake: 'press',        label: 'Press' },
        { id: 'doublePress', snake: 'double_press',  label: 'Double Press' },
        { id: 'longPress',   snake: 'long_press',    label: 'Long Press' },
      ];

      function renderKeybindings(keys) {
        const container = document.getElementById('view-keys');
        container.innerHTML = '';

        // Intro hint
        const hint = document.createElement('p');
        hint.className = 'kb-hint';
        hint.textContent =
          'Map each button gesture to an action returned to Claude Code. ' +
          'Action is the value sent on response (e.g. "approve"); ' +
          'Label is shown on the device display (e.g. "Yes").';
        container.appendChild(hint);

        for (let i = 0; i < 4; i++) {
          const keyId = 'key' + i;
          const keyMapping = keys[keyId] || {};

          const card = document.createElement('div');
          card.className = 'section';

          const title = document.createElement('h2');
          title.textContent = KB_KEY_NAMES[i];
          card.appendChild(title);

          // Column headers
          const header = document.createElement('div');
          header.className = 'kb-col-header';
          header.innerHTML =
            '<span class="kb-gesture-label"></span>' +
            '<span class="kb-col-name">Action</span>' +
            '<span class="kb-col-name">Label</span>';
          card.appendChild(header);

          for (const g of KB_GESTURES) {
            const mapping = keyMapping[g.id] || keyMapping[g.snake] || {};

            const row = document.createElement('div');
            row.className = 'kb-gesture-row';

            const lbl = document.createElement('span');
            lbl.className = 'kb-gesture-label';
            lbl.textContent = g.label;

            // Support both the action/label format and the older keys:[...] format.
            // If only keys is present, seed action with the joined sequence so the
            // user can see and edit what they previously had in their config.
            const keysStr = Array.isArray(mapping.keys) ? mapping.keys.join(', ') : '';

            const actionIn = document.createElement('input');
            actionIn.type = 'text';
            actionIn.id = 'kb-' + keyId + '-' + g.id + '-action';
            actionIn.value = mapping.action || keysStr;
            actionIn.placeholder = 'e.g. approve';

            const labelIn = document.createElement('input');
            labelIn.type = 'text';
            labelIn.id = 'kb-' + keyId + '-' + g.id + '-label';
            labelIn.value = mapping.label || '';
            labelIn.placeholder = 'e.g. Yes';

            row.append(lbl, actionIn, labelIn);
            card.appendChild(row);
          }

          container.appendChild(card);
        }

        // Status message
        const statusMsg = document.createElement('div');
        statusMsg.id = 'kb-status-msg';
        statusMsg.className = 'status-msg';
        container.appendChild(statusMsg);

        // Footer with Save button
        const footer = document.createElement('div');
        footer.className = 'footer';
        footer.innerHTML =
          '<button type="button" class="btn btn-secondary" onclick="window.close()">Cancel</button>' +
          '<button type="button" class="btn btn-primary" onclick="saveKeybindings()">Save</button>';
        container.appendChild(footer);
      }

      function collectKeybindings() {
        const keys = {};
        for (let i = 0; i < 4; i++) {
          const keyId = 'key' + i;
          const keyMapping = {};
          for (const g of KB_GESTURES) {
            const actionEl = document.getElementById('kb-' + keyId + '-' + g.id + '-action');
            const labelEl  = document.getElementById('kb-' + keyId + '-' + g.id + '-label');
            if (!actionEl || !labelEl) continue;
            const action = actionEl.value.trim();
            const label  = labelEl.value.trim();
            if (action || label) {
              keyMapping[g.id] = { action, label };
            }
          }
          if (Object.keys(keyMapping).length > 0) {
            keys[keyId] = keyMapping;
          }
        }
        return keys;
      }

      async function saveKeybindings() {
        const keys = collectKeybindings();
        const config = { ...currentConfig, keys };
        try {
          const res = await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config),
          });
          if (!res.ok) {
            showKbStatus('Save failed: ' + (await res.text()), 'error');
            return;
          }
          currentConfig = config;
          showKbStatus('Keybindings saved. camel-pad will reload the config.', 'success');
          setTimeout(() => fetch('/api/close').catch(() => {}), 1500);
        } catch (e) {
          showKbStatus('Save failed: ' + e.message, 'error');
        }
      }

      function showKbStatus(msg, type) {
        const el = document.getElementById('kb-status-msg');
        el.textContent = msg;
        el.className = 'status-msg ' + type;
      }

      // ── Settings view ────────────────────────────────────────────────

      document.querySelectorAll('input[name="deviceMode"]').forEach((radio) => {
        radio.addEventListener("change", () => {
          const mode = document.querySelector(
            'input[name="deviceMode"]:checked',
          ).value;
          document
            .getElementById("port-section")
            .classList.toggle("active", mode === "port");
          document
            .getElementById("id-section")
            .classList.toggle("active", mode === "ids");
        });
      });

      async function loadConfig() {
        let config;
        try {
          const res = await fetch("/api/config");
          config = await res.json();
          currentConfig = config;
        } catch (e) {
          showStatus("Failed to load config: " + e.message, "error");
          return;
        }
        try {
          populateForm(config);
        } catch (e) {
          showStatus("Failed to populate settings form: " + e.message, "error");
        }
        renderKeybindings(config.keys ?? {});
      }

      function populateForm(config) {
        const hasPort = !!config.device?.port;
        const hasIds = !!(config.device?.vendorId && config.device?.productId);

        if (hasPort) {
          document.querySelector(
            'input[name="deviceMode"][value="port"]',
          ).checked = true;
          document.getElementById("port-section").classList.add("active");
          document.getElementById("id-section").classList.remove("active");
          document.getElementById("port").value = config.device.port || "";
        } else if (hasIds) {
          document.querySelector(
            'input[name="deviceMode"][value="ids"]',
          ).checked = true;
          document.getElementById("port-section").classList.remove("active");
          document.getElementById("id-section").classList.add("active");
          document.getElementById("vendorId").value = config.device.vendorId
            ? "0x" + config.device.vendorId.toString(16)
            : "";
          document.getElementById("productId").value = config.device.productId
            ? "0x" + config.device.productId.toString(16)
            : "";
        }

        const handedness = config.handedness ?? "right";
        document.querySelector(
          `input[name="handedness"][value="${handedness}"]`,
        ).checked = true;

        document.getElementById("longPressMs").value =
          config.gestures?.longPressMs ?? 500;
        document.getElementById("doublePressMs").value =
          config.gestures?.doublePressMs ?? 300;
        document.getElementById("serverPort").value =
          config.server?.port ?? 52914;
        document.getElementById("serverHost").value =
          config.server?.host ?? "localhost";
        document.getElementById("timeoutMs").value =
          config.defaults?.timeoutMs ?? 30000;
      }

      async function scanDevices() {
        const btn = document.getElementById("scan-btn");
        btn.textContent = "Scanning...";
        btn.disabled = true;
        try {
          const res = await fetch("/api/devices");
          const devices = await res.json();
          const select = document.getElementById("port-select");
          select.innerHTML = '<option value="">Select a device...</option>';
          devices.length === 0
            ? (select.innerHTML +=
                '<option value="" disabled>No devices found</option>')
            : devices.forEach((d) => {
                const label = d.vendorId
                  ? `${d.path}  [${d.vendorId}:${d.productId}]`
                  : d.path;
                select.innerHTML += `<option value="${d.path}">${label}</option>`;
              });
          document.getElementById("scan-results").style.display = "block";
        } catch (e) {
          showStatus("Scan failed: " + e.message, "error");
        } finally {
          btn.textContent = "Scan";
          btn.disabled = false;
        }
      }

      async function saveConfig() {
        const mode = document.querySelector(
          'input[name="deviceMode"]:checked',
        ).value;
        const config = {
          device: {},
          gestures: {
            longPressMs: parseInt(document.getElementById("longPressMs").value),
            doublePressMs: parseInt(
              document.getElementById("doublePressMs").value,
            ),
          },
          server: {
            port: parseInt(document.getElementById("serverPort").value),
            host: document.getElementById("serverHost").value.trim(),
          },
          defaults: {
            timeoutMs: parseInt(document.getElementById("timeoutMs").value),
          },
          keys: currentConfig?.keys ?? {},
          handedness: document.querySelector('input[name="handedness"]:checked').value,
        };

        if (mode === "port") {
          const port = document.getElementById("port").value.trim();
          if (!port) {
            showStatus("Please enter a serial port path.", "error");
            return;
          }
          config.device.port = port;
        } else {
          const vid = parseInt(
            document.getElementById("vendorId").value.trim(),
            16,
          );
          const pid = parseInt(
            document.getElementById("productId").value.trim(),
            16,
          );
          if (!vid || !pid) {
            showStatus("Please enter valid vendor and product IDs.", "error");
            return;
          }
          config.device.vendorId = vid;
          config.device.productId = pid;
        }

        try {
          const res = await fetch("/api/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(config),
          });
          if (!res.ok) {
            showStatus("Save failed: " + (await res.text()), "error");
            return;
          }
          showStatus(
            "Settings saved. camel-pad will reconnect with the new config.",
            "success",
          );
          setTimeout(() => fetch("/api/close").catch(() => {}), 1500);
        } catch (e) {
          showStatus("Save failed: " + e.message, "error");
        }
      }

      function showStatus(msg, type) {
        const el = document.getElementById("status-msg");
        el.textContent = msg;
        el.className = "status-msg " + type;
      }

      // ── Control view ─────────────────────────────────────────────────

      async function updateConnectionStatus() {
        try {
          const res = await fetch("/api/status");
          const s = await res.json();
          const dot = document.getElementById("conn-dot");
          const lbl = document.getElementById("conn-label");
          if (s.connected) {
            dot.className = "conn-dot connected";
            lbl.textContent =
              "Connected" + (s.portPath ? " — " + s.portPath : "");
          } else {
            dot.className = "conn-dot disconnected";
            lbl.textContent = "Not connected";
          }
        } catch {
          /* ignore */
        }
      }

      function setFb(id, msg, isOk) {
        const el = document.getElementById(id);
        el.textContent = msg;
        el.className = "ctrl-fb " + (isOk ? "ok" : "err");
        setTimeout(() => {
          el.textContent = "";
          el.className = "ctrl-fb";
        }, 3000);
      }

      async function devicePost(path, body) {
        const res = await fetch(path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        return res.json();
      }

      async function sendDisplayText() {
        const text = document.getElementById("ctrl-text").value;
        try {
          const r = await devicePost("/api/device/text", { text });
          setFb("fb-text", r.ok ? "Sent" : r.error, r.ok);
        } catch (e) {
          setFb("fb-text", e.message, false);
        }
      }

      async function sendStatusText() {
        const text = document.getElementById("ctrl-status").value;
        try {
          const r = await devicePost("/api/device/status-text", { text });
          setFb("fb-status", r.ok ? "Sent" : r.error, r.ok);
        } catch (e) {
          setFb("fb-status", e.message, false);
        }
      }

      async function clearDisplay() {
        try {
          const r = await devicePost("/api/device/clear", {});
          setFb("fb-clear", r.ok ? "Cleared" : r.error, r.ok);
        } catch (e) {
          setFb("fb-clear", e.message, false);
        }
      }

      async function sendLabels() {
        const labels = [0, 1, 2, 3].map(
          (i) => document.getElementById("lbl" + i).value,
        );
        try {
          const r = await devicePost("/api/device/labels", { labels });
          setFb("fb-labels", r.ok ? "Applied" : r.error, r.ok);
        } catch (e) {
          setFb("fb-labels", e.message, false);
        }
      }

      function hexToRgb(hex) {
        const n = parseInt(hex.slice(1), 16);
        return { r: (n >> 16) & 0xff, g: (n >> 8) & 0xff, b: n & 0xff };
      }

      async function sendLeds() {
        const leds = [0, 1, 2, 3].map((i) => {
          const { r, g, b } = hexToRgb(
            document.getElementById("led" + i).value,
          );
          return { index: i, r, g, b };
        });
        try {
          const r = await devicePost("/api/device/leds", { leds });
          setFb("fb-leds", r.ok ? "✓" : r.error, r.ok);
        } catch (e) {
          setFb("fb-leds", e.message, false);
        }
      }

      async function sendNotify() {
        const text = document.getElementById("notify-text").value.trim();
        const category =
          document.getElementById("notify-category").value.trim() || undefined;
        const resultEl = document.getElementById("notify-result");

        if (!text) {
          resultEl.textContent = "Enter notification text first.";
          resultEl.className = "notify-result visible err";
          return;
        }

        const wsPort = currentConfig?.server?.port ?? 52914;
        const id = crypto.randomUUID();

        resultEl.textContent = "Waiting for response…";
        resultEl.className = "notify-result visible";

        let ws;
        try {
          ws = new WebSocket("ws://localhost:" + wsPort);
        } catch (e) {
          resultEl.textContent = "WebSocket error: " + e.message;
          resultEl.className = "notify-result visible err";
          return;
        }

        const timeout = setTimeout(() => {
          ws.close();
          resultEl.textContent = "Timed out waiting for response.";
          resultEl.className = "notify-result visible err";
        }, 30000);

        ws.onopen = () => {
          ws.send(
            JSON.stringify({
              type: "notification",
              id,
              text,
              ...(category ? { category } : {}),
            }),
          );
        };

        ws.onmessage = (evt) => {
          try {
            const msg = JSON.parse(evt.data);
            if (msg.id !== id) return;
            clearTimeout(timeout);
            ws.close();
            if (msg.type === "response") {
              resultEl.textContent =
                'Response: action="' +
                msg.action +
                '" label="' +
                msg.label +
                '"';
              resultEl.className = "notify-result visible ok";
            } else if (msg.type === "error") {
              resultEl.textContent = "Error: " + msg.error;
              resultEl.className = "notify-result visible err";
            }
          } catch {
            /* ignore non-JSON */
          }
        };

        ws.onerror = () => {
          clearTimeout(timeout);
          resultEl.textContent = "Could not connect to WebSocket server.";
          resultEl.className = "notify-result visible err";
        };
      }

      loadConfig();

      // Control tab is default — start polling immediately
      updateConnectionStatus();
      statusPollInterval = setInterval(updateConnectionStatus, 3000);
    </script>
  </body>
</html>
