<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Camel Pad Settings</title>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-size: 13px;
        background: #f5f5f7;
        color: #1d1d1f;
        padding: 24px;
        min-width: 480px;
        max-width: 600px;
        margin: 0 auto;
      }

      h1 {
        font-size: 22px;
        font-weight: 600;
        margin-bottom: 20px;
        color: #1d1d1f;
      }

      .section {
        background: #fff;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .section h2 {
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #6e6e73;
        margin-bottom: 12px;
      }

      .field {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 6px 0;
      }

      .field:not(:last-child) {
        border-bottom: 1px solid #f0f0f2;
      }

      .field label {
        flex: 0 0 160px;
        color: #1d1d1f;
      }

      .field input[type="text"],
      .field input[type="number"],
      .field select {
        flex: 1;
        height: 28px;
        border: 1px solid #d2d2d7;
        border-radius: 6px;
        padding: 0 8px;
        font-size: 13px;
        font-family: inherit;
        background: #fff;
        color: #1d1d1f;
        outline: none;
        transition: border-color 0.15s;
      }

      .field input:focus,
      .field select:focus {
        border-color: #0071e3;
        box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.2);
      }

      .field .hint {
        color: #6e6e73;
        font-size: 11px;
        flex: 0 0 auto;
      }

      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex: 1;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 28px;
        padding: 0 14px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 13px;
        font-family: inherit;
        font-weight: 500;
        transition: opacity 0.15s;
      }

      .btn:hover {
        opacity: 0.85;
      }
      .btn:active {
        opacity: 0.7;
      }

      .btn-primary {
        background: #0071e3;
        color: #fff;
      }

      .btn-secondary {
        background: #e8e8ed;
        color: #1d1d1f;
      }

      .btn-small {
        height: 24px;
        padding: 0 10px;
        font-size: 12px;
      }

      .footer {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 8px;
      }

      .device-mode {
        display: flex;
        gap: 16px;
        margin-bottom: 12px;
      }

      .device-mode label {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
      }

      #port-section,
      #id-section {
        display: none;
      }
      #port-section.active,
      #id-section.active {
        display: block;
      }

      #scan-results {
        margin-top: 8px;
        display: none;
      }

      #scan-results select {
        width: 100%;
        height: 28px;
        border: 1px solid #d2d2d7;
        border-radius: 6px;
        padding: 0 8px;
        font-size: 13px;
        font-family: inherit;
        background: #fff;
      }

      .status-msg {
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 13px;
        margin-top: 12px;
        display: none;
      }

      .status-msg.success {
        background: #d4f4dd;
        color: #1a5c2a;
        display: block;
      }
      .status-msg.error {
        background: #fde8e8;
        color: #8b1a1a;
        display: block;
      }
    </style>
  </head>
  <body>
    <h1>Camel Pad Settings</h1>

    <div class="section">
      <h2>Device</h2>

      <div class="device-mode">
        <label
          ><input type="radio" name="deviceMode" value="port" checked /> Serial
          Port</label
        >
        <label
          ><input type="radio" name="deviceMode" value="ids" /> Vendor/Product
          ID</label
        >
      </div>

      <div id="port-section" class="active">
        <div class="field">
          <label>Serial Port</label>
          <div class="row">
            <input type="text" id="port" placeholder="/dev/cu.usbmodem..." />
            <button
              type="button"
              class="btn btn-secondary btn-small"
              id="scan-btn"
              onclick="scanDevices()"
            >
              Scan
            </button>
          </div>
        </div>
        <div id="scan-results">
          <select
            id="port-select"
            onchange="document.getElementById('port').value = this.value"
          >
            <option value="">Select a device...</option>
          </select>
        </div>
      </div>

      <div id="id-section">
        <div class="field">
          <label>Vendor ID</label>
          <input type="text" id="vendorId" placeholder="0x303A" />
          <span class="hint">hex</span>
        </div>
        <div class="field">
          <label>Product ID</label>
          <input type="text" id="productId" placeholder="0x1001" />
          <span class="hint">hex</span>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Gestures</h2>
      <div class="field">
        <label>Long Press</label>
        <input type="number" id="longPressMs" min="100" max="5000" step="50" />
        <span class="hint">ms</span>
      </div>
      <div class="field">
        <label>Double Press Window</label>
        <input type="number" id="doublePressMs" min="50" max="2000" step="50" />
        <span class="hint">ms</span>
      </div>
    </div>

    <div class="section">
      <h2>Server</h2>
      <div class="field">
        <label>WebSocket Port</label>
        <input type="number" id="serverPort" min="1024" max="65535" />
      </div>
      <div class="field">
        <label>Host</label>
        <input type="text" id="serverHost" placeholder="localhost" />
      </div>
    </div>

    <div class="section">
      <h2>Notification Timeout</h2>
      <div class="field">
        <label>Timeout</label>
        <input
          type="number"
          id="timeoutMs"
          min="1000"
          max="300000"
          step="1000"
        />
        <span class="hint">ms</span>
      </div>
    </div>

    <div id="status-msg" class="status-msg"></div>

    <div class="footer">
      <button type="button" class="btn btn-secondary" onclick="window.close()">
        Cancel
      </button>
      <button type="button" class="btn btn-primary" onclick="saveConfig()">
        Save
      </button>
    </div>

    <script>
      let currentConfig = null;

      // Device mode toggle
      document.querySelectorAll('input[name="deviceMode"]').forEach((radio) => {
        radio.addEventListener("change", () => {
          const mode = document.querySelector(
            'input[name="deviceMode"]:checked',
          ).value;
          document
            .getElementById("port-section")
            .classList.toggle("active", mode === "port");
          document
            .getElementById("id-section")
            .classList.toggle("active", mode === "ids");
        });
      });

      async function loadConfig() {
        try {
          const res = await fetch("/api/config");
          currentConfig = await res.json();
          populateForm(currentConfig);
        } catch (e) {
          showStatus("Failed to load config: " + e.message, "error");
        }
      }

      function populateForm(config) {
        const hasPort = !!config.device?.port;
        const hasIds = !!(config.device?.vendorId && config.device?.productId);

        if (hasPort) {
          document.querySelector(
            'input[name="deviceMode"][value="port"]',
          ).checked = true;
          document.getElementById("port-section").classList.add("active");
          document.getElementById("id-section").classList.remove("active");
          document.getElementById("port").value = config.device.port || "";
        } else if (hasIds) {
          document.querySelector(
            'input[name="deviceMode"][value="ids"]',
          ).checked = true;
          document.getElementById("port-section").classList.remove("active");
          document.getElementById("id-section").classList.add("active");
          document.getElementById("vendorId").value = config.device.vendorId
            ? "0x" + config.device.vendorId.toString(16)
            : "";
          document.getElementById("productId").value = config.device.productId
            ? "0x" + config.device.productId.toString(16)
            : "";
        }

        document.getElementById("longPressMs").value =
          config.gestures?.longPressMs ?? 500;
        document.getElementById("doublePressMs").value =
          config.gestures?.doublePressMs ?? 300;
        document.getElementById("serverPort").value =
          config.server?.port ?? 52914;
        document.getElementById("serverHost").value =
          config.server?.host ?? "localhost";
        document.getElementById("timeoutMs").value =
          config.defaults?.timeoutMs ?? 30000;
      }

      async function scanDevices() {
        const btn = document.getElementById("scan-btn");
        btn.textContent = "Scanning...";
        btn.disabled = true;
        try {
          const res = await fetch("/api/devices");
          const devices = await res.json();
          const select = document.getElementById("port-select");
          select.innerHTML = '<option value="">Select a device...</option>';
          if (devices.length === 0) {
            select.innerHTML +=
              '<option value="" disabled>No devices found</option>';
          } else {
            devices.forEach((d) => {
              const label = d.vendorId
                ? `${d.path}  [${d.vendorId}:${d.productId}]`
                : d.path;
              select.innerHTML += `<option value="${d.path}">${label}</option>`;
            });
          }
          document.getElementById("scan-results").style.display = "block";
        } catch (e) {
          showStatus("Scan failed: " + e.message, "error");
        } finally {
          btn.textContent = "Scan";
          btn.disabled = false;
        }
      }

      async function saveConfig() {
        const mode = document.querySelector(
          'input[name="deviceMode"]:checked',
        ).value;

        const config = {
          device: {},
          gestures: {
            longPressMs: parseInt(document.getElementById("longPressMs").value),
            doublePressMs: parseInt(
              document.getElementById("doublePressMs").value,
            ),
          },
          server: {
            port: parseInt(document.getElementById("serverPort").value),
            host: document.getElementById("serverHost").value.trim(),
          },
          defaults: {
            timeoutMs: parseInt(document.getElementById("timeoutMs").value),
          },
          keys: currentConfig?.keys ?? {},
        };

        if (mode === "port") {
          const port = document.getElementById("port").value.trim();
          if (!port) {
            showStatus("Please enter a serial port path.", "error");
            return;
          }
          config.device.port = port;
        } else {
          const vidStr = document.getElementById("vendorId").value.trim();
          const pidStr = document.getElementById("productId").value.trim();
          const vid = parseInt(vidStr, 16);
          const pid = parseInt(pidStr, 16);
          if (!vid || !pid) {
            showStatus("Please enter valid vendor and product IDs.", "error");
            return;
          }
          config.device.vendorId = vid;
          config.device.productId = pid;
        }

        try {
          const res = await fetch("/api/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(config),
          });
          if (!res.ok) {
            const text = await res.text();
            showStatus("Save failed: " + text, "error");
            return;
          }
          showStatus(
            "Settings saved. camel-pad will reconnect with the new config.",
            "success",
          );
          setTimeout(() => fetch("/api/close").catch(() => {}), 1500);
        } catch (e) {
          showStatus("Save failed: " + e.message, "error");
        }
      }

      function showStatus(msg, type) {
        const el = document.getElementById("status-msg");
        el.textContent = msg;
        el.className = "status-msg " + type;
      }

      loadConfig();
    </script>
  </body>
</html>
